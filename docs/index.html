<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>BNR Exchange Rate Monitor - Dashboard</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/date-fns@2.29.3/index.min.js"></script>
    <script src="../api/proxy.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            color: #333;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }

        .header {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border-radius: 15px;
            padding: 30px;
            margin-bottom: 30px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
        }

        .header h1 {
            color: #2c3e50;
            font-size: 2.5rem;
            margin-bottom: 10px;
            text-align: center;
        }

        .header p {
            color: #7f8c8d;
            text-align: center;
            font-size: 1.1rem;
        }

        .status-bar {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 30px;
            flex-wrap: wrap;
            gap: 15px;
        }

        .status-item {
            background: rgba(255, 255, 255, 0.9);
            padding: 15px 20px;
            border-radius: 10px;
            text-align: center;
            min-width: 150px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
        }

        .status-item h3 {
            color: #2c3e50;
            margin-bottom: 5px;
            font-size: 0.9rem;
        }

        .status-item .value {
            font-size: 1.5rem;
            font-weight: bold;
            color: #27ae60;
        }

        .status-item.warning .value {
            color: #f39c12;
        }

        .status-item.error .value {
            color: #e74c3c;
        }

        .grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(350px, 1fr));
            gap: 30px;
            margin-bottom: 30px;
        }

        .card {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border-radius: 15px;
            padding: 25px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
            transition: transform 0.3s ease, box-shadow 0.3s ease;
        }

        .card:hover {
            transform: translateY(-5px);
            box-shadow: 0 12px 40px rgba(0, 0, 0, 0.15);
        }

        .card h2 {
            color: #2c3e50;
            margin-bottom: 20px;
            font-size: 1.4rem;
            border-bottom: 2px solid #3498db;
            padding-bottom: 10px;
        }

        .rate-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px;
            margin: 10px 0;
            background: #f8f9fa;
            border-radius: 8px;
            border-left: 4px solid #3498db;
        }

        .rate-item .currency {
            font-weight: bold;
            font-size: 1.1rem;
            color: #2c3e50;
        }

        .rate-item .rate {
            font-size: 1.2rem;
            font-weight: bold;
            color: #27ae60;
        }

        .rate-item .source {
            font-size: 0.8rem;
            color: #7f8c8d;
            margin-top: 5px;
        }

        .chart-container {
            position: relative;
            height: 300px;
            margin-top: 20px;
        }

        .btn {
            background: #3498db;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 1rem;
            transition: background 0.3s ease;
            margin: 5px;
        }

        .btn:hover {
            background: #2980b9;
        }

        .btn-success {
            background: #27ae60;
        }

        .btn-success:hover {
            background: #229954;
        }

        .loading {
            text-align: center;
            padding: 20px;
            color: #7f8c8d;
        }

        .error {
            background: #fadbd8;
            color: #e74c3c;
            padding: 15px;
            border-radius: 8px;
            margin: 10px 0;
        }

        .success {
            background: #d5f4e6;
            color: #27ae60;
            padding: 15px;
            border-radius: 8px;
            margin: 10px 0;
        }

        .api-info {
            background: #e8f4fd;
            border: 1px solid #3498db;
            border-radius: 8px;
            padding: 20px;
            margin: 20px 0;
        }

        .api-info h3 {
            color: #2c3e50;
            margin-bottom: 15px;
        }

        .api-endpoint {
            background: #f8f9fa;
            padding: 10px;
            border-radius: 4px;
            margin: 5px 0;
            font-family: monospace;
            font-size: 0.9rem;
        }

        @media (max-width: 768px) {
            .grid {
                grid-template-columns: 1fr;
            }
            
            .status-bar {
                flex-direction: column;
            }
            
            .header h1 {
                font-size: 2rem;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üè¶ BNR Exchange Rate Monitor</h1>
            <p>Real-time exchange rate monitoring and analysis dashboard</p>
        </div>

        <div class="status-bar">
            <div class="status-item" id="system-status">
                <h3>System Status</h3>
                <div class="value" id="system-status-value">Loading...</div>
            </div>
            <div class="status-item" id="last-update">
                <h3>Last Update</h3>
                <div class="value" id="last-update-value">-</div>
            </div>
            <div class="status-item" id="rates-count">
                <h3>Rates Available</h3>
                <div class="value" id="rates-count-value">-</div>
            </div>
            <div class="status-item" id="sources-count">
                <h3>Active Sources</h3>
                <div class="value" id="sources-count-value">-</div>
            </div>
        </div>

        <div class="grid">
            <!-- Current Rates Card -->
            <div class="card">
                <h2>üí± Current Exchange Rates</h2>
                <div id="current-rates">
                    <div class="loading">Loading rates...</div>
                </div>
                <button class="btn btn-success" onclick="refreshRates()">üîÑ Refresh Rates</button>
            </div>

            <!-- Rate Trends Card -->
            <div class="card">
                <h2>üìà Rate Trends (7 days)</h2>
                <div class="chart-container">
                    <canvas id="trends-chart"></canvas>
                </div>
            </div>

            <!-- Data Sources Card -->
            <div class="card">
                <h2>üîó Data Sources</h2>
                <div id="sources-status">
                    <div class="loading">Loading sources...</div>
                </div>
                <button class="btn" onclick="refreshSources()">üîÑ Refresh Sources</button>
            </div>

            <!-- System Health Card -->
            <div class="card">
                <h2>üè• System Health</h2>
                <div id="health-status">
                    <div class="loading">Loading health status...</div>
                </div>
                <button class="btn" onclick="refreshHealth()">üîÑ Refresh Health</button>
            </div>

            <!-- Statistics Card -->
            <div class="card">
                <h2>üìä Statistics</h2>
                <div id="statistics">
                    <div class="loading">Loading statistics...</div>
                </div>
            </div>

            <!-- API Information Card -->
            <div class="card">
                <h2>üîå API Information</h2>
                <div class="api-info">
                    <h3>Available Endpoints:</h3>
                    <div class="api-endpoint">GET /api/rates/latest</div>
                    <div class="api-endpoint">GET /api/rates/history?days=30</div>
                    <div class="api-endpoint">GET /api/rates/trends?currency=EUR&days=7</div>
                    <div class="api-endpoint">GET /api/health</div>
                    <div class="api-endpoint">GET /api/sources/status</div>
                    <div class="api-endpoint">GET /api/export?format=json&days=30</div>
                </div>
                <p><strong>Base URL:</strong> <code>https://bogdanrobu92.github.io/CURS_BNR/api/</code></p>
            </div>
        </div>
    </div>

    <script>
        // Configuration
        let trendsChart = null;

        // Initialize dashboard
        document.addEventListener('DOMContentLoaded', function() {
            loadDashboard();
            setInterval(loadDashboard, 30000); // Refresh every 30 seconds
        });

        async function loadDashboard() {
            await Promise.all([
                loadCurrentRates(),
                loadSourcesStatus(),
                loadHealthStatus(),
                loadStatistics(),
                loadTrends()
            ]);
        }

        async function loadCurrentRates() {
            try {
                const data = await window.BNR_API.getLatestRates();
                
                if (data.success) {
                    displayCurrentRates(data.data);
                    updateLastUpdate(data.timestamp);
                    updateRatesCount(Object.keys(data.data).length);
                } else {
                    showError('current-rates', data.error);
                }
            } catch (error) {
                showError('current-rates', 'Failed to load current rates');
            }
        }

        function displayCurrentRates(rates) {
            const container = document.getElementById('current-rates');
            container.innerHTML = '';
            
            for (const [currency, rateData] of Object.entries(rates)) {
                const rateItem = document.createElement('div');
                rateItem.className = 'rate-item';
                rateItem.innerHTML = `
                    <div>
                        <div class="currency">${currency}</div>
                        <div class="source">Source: ${rateData.source}</div>
                    </div>
                    <div class="rate">${rateData.rate.toFixed(4)} RON</div>
                `;
                container.appendChild(rateItem);
            }
        }

        async function loadSourcesStatus() {
            try {
                const data = await window.BNR_API.getSourcesStatus();
                
                if (data.success) {
                    displaySourcesStatus(data.data);
                    updateSourcesCount(data.data);
                } else {
                    showError('sources-status', data.error);
                }
            } catch (error) {
                showError('sources-status', 'Failed to load sources status');
            }
        }

        function displaySourcesStatus(sources) {
            const container = document.getElementById('sources-status');
            container.innerHTML = '<div class="sources-grid"></div>';
            const grid = container.querySelector('.sources-grid');
            
            for (const [name, status] of Object.entries(sources)) {
                const sourceItem = document.createElement('div');
                sourceItem.className = `source-item ${status.available ? 'available' : 'unavailable'}`;
                sourceItem.innerHTML = `
                    <h4>${name}</h4>
                    <div class="source-status ${status.available ? 'available' : 'unavailable'}">
                        ${status.available ? 'Available' : 'Unavailable'}
                    </div>
                    ${status.available ? `<div>Response: ${status.response_time?.toFixed(2)}s</div>` : ''}
                    ${status.available ? `<div>Rates: ${status.rates_count}</div>` : ''}
                `;
                grid.appendChild(sourceItem);
            }
        }

        async function loadHealthStatus() {
            try {
                const data = await window.BNR_API.getHealthStatus();
                
                if (data.success) {
                    displayHealthStatus(data.data);
                    updateSystemStatus(data.data.overall_status);
                } else {
                    showError('health-status', data.error);
                }
            } catch (error) {
                showError('health-status', 'Failed to load health status');
            }
        }

        function displayHealthStatus(health) {
            const container = document.getElementById('health-status');
            container.innerHTML = '';
            
            for (const check of health.checks) {
                const checkItem = document.createElement('div');
                checkItem.className = 'rate-item';
                checkItem.innerHTML = `
                    <div>
                        <div class="currency">${check.service}</div>
                        <div class="source">${check.message}</div>
                    </div>
                    <div class="rate ${check.status}">${check.status.toUpperCase()}</div>
                `;
                container.appendChild(checkItem);
            }
            
            if (health.alerts && health.alerts.length > 0) {
                const alertDiv = document.createElement('div');
                alertDiv.className = 'error';
                alertDiv.innerHTML = `<strong>Alerts:</strong><br>${health.alerts.join('<br>')}`;
                container.appendChild(alertDiv);
            }
        }

        async function loadStatistics() {
            try {
                const data = await window.BNR_API.getStatistics('EUR', 30);
                
                if (data.success) {
                    displayStatistics(data.data);
                } else {
                    showError('statistics', data.error);
                }
            } catch (error) {
                showError('statistics', 'Failed to load statistics');
            }
        }

        function displayStatistics(stats) {
            const container = document.getElementById('statistics');
            container.innerHTML = `
                <div class="rate-item">
                    <div class="currency">Average Rate</div>
                    <div class="rate">${stats.avg_rate?.toFixed(4) || 'N/A'} RON</div>
                </div>
                <div class="rate-item">
                    <div class="currency">Min Rate</div>
                    <div class="rate">${stats.min_rate?.toFixed(4) || 'N/A'} RON</div>
                </div>
                <div class="rate-item">
                    <div class="currency">Max Rate</div>
                    <div class="rate">${stats.max_rate?.toFixed(4) || 'N/A'} RON</div>
                </div>
                <div class="rate-item">
                    <div class="currency">Total Rates</div>
                    <div class="rate">${stats.total_rates || 0}</div>
                </div>
                <div class="rate-item">
                    <div class="currency">Days with Data</div>
                    <div class="rate">${stats.days_with_data || 0}</div>
                </div>
            `;
        }

        async function loadTrends() {
            try {
                const data = await window.BNR_API.getRateTrends('EUR', 7);
                
                if (data.success) {
                    displayTrendsChart(data.data);
                } else {
                    showError('trends-chart', data.error);
                }
            } catch (error) {
                showError('trends-chart', 'Failed to load trends');
            }
        }

        function displayTrendsChart(trends) {
            const ctx = document.getElementById('trends-chart').getContext('2d');
            
            if (trendsChart) {
                trendsChart.destroy();
            }
            
            const labels = trends.map(t => new Date(t.timestamp).toLocaleDateString());
            const rates = trends.map(t => t.current_rate);
            const changes = trends.map(t => t.change_percentage);
            
            trendsChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'EUR Rate (RON)',
                        data: rates,
                        borderColor: '#3498db',
                        backgroundColor: 'rgba(52, 152, 219, 0.1)',
                        tension: 0.4
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: {
                            beginAtZero: false
                        }
                    }
                }
            });
        }

        async function refreshRates() {
            try {
                // For GitHub Pages, we can't trigger a refresh, but we can reload the data
                showSuccess('Refreshing rates...');
                await loadCurrentRates();
                showSuccess('Rates refreshed successfully!');
            } catch (error) {
                showError('Failed to refresh rates');
            }
        }

        function refreshSources() {
            loadSourcesStatus();
        }

        function refreshHealth() {
            loadHealthStatus();
        }

        function updateSystemStatus(status) {
            const element = document.getElementById('system-status-value');
            element.textContent = status.toUpperCase();
            element.parentElement.className = `status-item ${status}`;
        }

        function updateLastUpdate(timestamp) {
            const element = document.getElementById('last-update-value');
            element.textContent = new Date(timestamp).toLocaleTimeString();
        }

        function updateRatesCount(count) {
            const element = document.getElementById('rates-count-value');
            element.textContent = count;
        }

        function updateSourcesCount(sources) {
            const availableCount = Object.values(sources).filter(s => s.available).length;
            const element = document.getElementById('sources-count-value');
            element.textContent = `${availableCount}/${Object.keys(sources).length}`;
        }

        function showError(containerId, message) {
            const container = document.getElementById(containerId);
            container.innerHTML = `<div class="error">Error: ${message}</div>`;
        }

        function showSuccess(message) {
            // Create a temporary success message
            const successDiv = document.createElement('div');
            successDiv.className = 'success';
            successDiv.textContent = message;
            successDiv.style.position = 'fixed';
            successDiv.style.top = '20px';
            successDiv.style.right = '20px';
            successDiv.style.zIndex = '1000';
            document.body.appendChild(successDiv);
            
            setTimeout(() => {
                document.body.removeChild(successDiv);
            }, 3000);
        }
    </script>
</body>
</html>
